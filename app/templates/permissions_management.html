{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-body">
        <h2 class="card-title">Role & Permissions Management</h2>
        
        <!-- Role List -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Roles</h5>
                    </div>
                    <div class="list-group list-group-flush role-list">
                        {% for role in roles %}
                        <a href="#" class="list-group-item list-group-item-action {% if selected_role and selected_role.id == role.id %}active{% endif %}"
                           data-role-id="{{ role.id }}">
                            {{ role.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Permissions for <span id="selected-role-name">{{ selected_role.name if selected_role else 'Select a role' }}</span></h5>
                    </div>
                    <div class="card-body">
                        {% if selected_role %}
                        <form id="permissions-form" method="POST" action="{{ url_for('main.update_permissions', role_id=selected_role.id) }}">
                            {{ form.hidden_tag() }}
                            
                            <div class="row">
                                <!-- Page Access Permissions -->
                                <div class="col-md-6 mb-4">
                                    <h6 class="mb-3">Page Access</h6>
                                    {% for permission in page_permissions %}
                                    <div class="form-check mb-2">
                                        <input type="checkbox" class="form-check-input" 
                                               id="{{ permission.value }}" 
                                               name="permissions" 
                                               value="{{ permission.value }}"
                                               {% if selected_role.has_permission(permission) %}checked{% endif %}
                                               {% if selected_role.name == 'superadmin' %}disabled{% endif %}>
                                        <label class="form-check-label" for="{{ permission.value }}">
                                            {{ permission.value|replace('_', ' ')|title }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Action Permissions -->
                                <div class="col-md-6 mb-4">
                                    <h6 class="mb-3">Actions</h6>
                                    {% for permission in action_permissions %}
                                    <div class="form-check mb-2">
                                        <input type="checkbox" class="form-check-input"
                                               id="{{ permission.value }}"
                                               name="permissions"
                                               value="{{ permission.value }}"
                                               {% if selected_role.has_permission(permission) %}checked{% endif %}
                                               {% if selected_role.name == 'superadmin' %}disabled{% endif %}>
                                        <label class="form-check-label" for="{{ permission.value }}">
                                            {{ permission.value|replace('_', ' ')|title }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            {% if selected_role.name != 'superadmin' %}
                            <button type="submit" class="btn btn-primary">Save Permissions</button>
                            {% endif %}
                        </form>
                        {% else %}
                        <p class="text-muted">Select a role to manage its permissions</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.role-list {
    max-height: 400px;
    overflow-y: auto;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleLinks = document.querySelectorAll('.role-list .list-group-item');
    roleLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const roleId = this.dataset.roleId;
            window.location.href = `{{ url_for('main.permissions_management') }}?role_id=${roleId}`;
        });
    });
});
</script>
{% endblock %} 